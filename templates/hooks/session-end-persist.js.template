#!/usr/bin/env node
// Hook: SessionEnd
// Saves a session state snapshot for continuity between sessions.

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

function execGit(cmd) {
  try {
    return execSync(cmd, { encoding: 'utf8', stdio: ['pipe', 'pipe', 'pipe'] }).trim();
  } catch {
    return '';
  }
}

async function main() {
  let input = '';
  for await (const chunk of process.stdin) input += chunk;
  const data = JSON.parse(input);

  const cwd = data.cwd || process.env.CLAUDE_PROJECT_DIR || process.cwd();
  const docsPath = path.join(cwd, '{{DOCS_PATH}}');

  const date = new Date().toISOString().split('T')[0];
  const branch = execGit('git branch --show-current') || 'unknown';
  const modifiedFiles = execGit('git diff --name-only HEAD');

  const fileList = modifiedFiles
    ? modifiedFiles.split('\n').filter(Boolean).map((f) => '- ' + f).join('\n')
    : '- No modified files detected';

  const content =
    '# Session State Snapshot\n\n' +
    '> Auto-generated by SpecFlow session-end hook. Review and incorporate into SESSION_LOG.md.\n\n' +
    '**Date**: ' + date + '\n' +
    '**Branch**: ' + branch + '\n\n' +
    '## Modified Files\n\n' +
    fileList + '\n\n' +
    '---\n\n' +
    '*This file is overwritten each session. Transfer relevant details to SESSION_LOG.md.*\n';

  try {
    // Ensure docs directory exists
    if (!fs.existsSync(docsPath)) {
      fs.mkdirSync(docsPath, { recursive: true });
    }
    fs.writeFileSync(path.join(docsPath, '.session-state.md'), content, 'utf8');
  } catch (err) {
    process.stderr.write('session-end-persist: could not write state file: ' + err.message + '\n');
  }

  process.exit(0);
}

main().catch((err) => {
  process.stderr.write('session-end-persist: ' + err.message + '\n');
  process.exit(0);
});
