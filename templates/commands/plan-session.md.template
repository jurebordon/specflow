# Plan Session

> Plan your next implementation session by selecting a task and creating a detailed plan.

---

## Step 1: Detect Feature Context

Determine which feature you're working on:

```bash
# Get current branch
CURRENT_BRANCH=$(git branch --show-current)
```

Extract feature name from branch:
- Pattern `feat/user-auth` → feature: `user-auth`
- Pattern `feature/api-v2` → feature: `api-v2`
- Pattern `PROJ-123-payment` → feature: `payment`
- Pattern `user-auth` → feature: `user-auth`

If branch doesn't match a feature pattern, ask user: "Which feature are you working on?"

---

## Step 2: Read Context

### Always Read:
- `CLAUDE.md` - Project overview and patterns
- `docs_specflow/ROADMAP.md` - All tasks
- `docs_specflow/SESSION_LOG.md` (last 3 entries) - Recent work

### If Feature Detected:
- `docs_specflow/feature_docs/{{FEATURE_NAME}}/SPEC.md` - Feature requirements (north star)

### As Needed:
- `docs_specflow/OVERVIEW.md` - System architecture
- `docs_specflow/ADR.md` - Architecture decisions
- `docs_specflow/WORKFLOW.md` - Tech-specific commands

---

## Step 3: Filter Tasks by Feature

From `docs_specflow/ROADMAP.md`, find tasks tagged with `[feature: {{FEATURE_NAME}}]`:

```markdown
## Now
- [ ] Add login endpoint [feature: user-auth]  ← Match!
- [ ] Create user model [feature: user-auth]   ← Match!
- [ ] Build API schema [feature: api-v2]       ← Skip

## Next
1. Add password reset [feature: user-auth]     ← Match!
2. Add API versioning [feature: api-v2]        ← Skip
```

Only show tasks matching the detected feature.

---

## Step 4: Create Session Plan

Present a plan to the user:

```markdown
## Session Plan

**Feature**: {{FEATURE_NAME}}
**Branch**: {{CURRENT_BRANCH}}

**Session Goal**: [ONE task from filtered ROADMAP, pick from Now or top of Next]

**Implementation Steps**:
1. [Concrete step 1]
2. [Concrete step 2]
3. [Concrete step 3]

**Files Likely to Change**:
- [file1.py]
- [file2.py]
- [tests/test_file.py]

**Success Criteria**:
- [ ] [How we'll know it's done]
- [ ] [Tests pass]

**Questions/Blockers**:
- [Any unclear items before starting]

{{#if TICKETING}}
**Ticket**: {{TICKET_REFERENCE}}
{{/if}}
```

---

## Step 5: Wait for Approval

**Do NOT start implementing.** Present the plan and wait for user confirmation.

User may:
- Approve → proceed to `/start-session`
- Request changes → revise plan
- Pick different task → update plan

---

## Notes

- Feature detection is automatic from branch name
- Tasks without feature tags won't be shown (remind user to add tags)
- If no feature detected and multiple features exist, ask user to clarify
- Plan should be specific enough to start coding immediately
- Include test strategy in success criteria
